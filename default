#!/usr/bin/python
import cgitb
cgitb.enable()

from wsgiref.handlers import CGIHandler
import os
import datetime

from flask import Flask
from flask.helpers import make_response

app = Flask(__name__)

# Get the "root" url path, because
# Flask isn't running at the domain root.
path = os.environ['PATH_INFO']
root = '/'.join(path.split('/')[0:5])

id = 'https://{}{}'.format(os.environ['HTTP_HOST'], os.environ['PATH_INFO'])

@app.route(root + "/")
def tables():
    resp = make_response("""<?xml version="1.0" encoding="utf-8" standalone="yes"?>
    <service xmlns:atom="http://www.w3.org/2005/Atom" xmlns:app="http://www.w3.org/2007/app" xmlns="http://www.w3.org/2007/app" xml:base="{id}">
        <workspace>
            <atom:title>Default</atom:title>
            <collection href="tweets">
                <atom:title>tweets</atom:title>
            </collection>
        </workspace>
    </service>""".format(id=id))
    resp.headers['Content-Type'] = 'application/xml;charset=utf-8'

    return resp

@app.route(root + "/<table>")
def table(table):
    resp = make_response("""<?xml version="1.0" encoding="utf-8" standalone="yes"?>
    <feed xml:base="{id}" xmlns:d="http://schemas.microsoft.com/ado/2007/08/dataservices" xmlns:m="http://schemas.microsoft.com/ado/2007/08/dataservices/metadata" xmlns="http://www.w3.org/2005/Atom">
      <title type="text">tweets</title>
      <id>{id}</id>
      <updated>2014-02-19T14:13:38Z</updated>
      <link rel="self" title="tweets" href="tweets" />
      <entry>
        <id>{id}(1)</id>
        <title type="text"></title>
        <updated>2014-02-19T14:13:38Z</updated>
        <author>
          <name />
        </author>
        <link rel="edit" title="tweets" href="tweets(1)" />
        <category term="scraperwiki.com.sql" scheme="http://schemas.microsoft.com/ado/2007/08/dataservices/scheme" />
        <content type="application/xml">
          <m:properties>
            <d:ROWID m:type="Edm.Int32">1</d:ROWID>
            <d:screen_name>zarino</d:screen_name>
            <d:text>example tweet</d:text>
          </m:properties>
        </content>
      </entry>
    </feed>
    """.format(id=id))
    resp.headers['Content-Type'] = 'application/xml;charset=utf-8'

    return resp

CGIHandler().run(app)
